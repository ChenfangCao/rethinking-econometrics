---
title: "Regression and Other Stories: SimpleCausal"
author: "Andrew Gelman, Jennifer Hill, Aki Vehtari"
date: "`r format(Sys.Date())`"

---
Simple graphs illustrating regression for causal inference. See
Chapter 1 in Regression and Other Stories.

-------------


```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, error=FALSE, warning=FALSE, comment=NA)
# switch this to TRUE to save figures in separate files
savefigs <- TRUE
```

**Load packages**

```{r }
library(rprojroot)
root<-rprojroot::has_dir("03-statistical-inference-simulation")$make_fix_file()
library("arm")
```

**Simulated data from linear model**

```{r }
N <- 50
x <- runif(N, 1, 5)
y <- rnorm(N, 10 + 3*x, 3)
x_binary <- ifelse(x<3, 0, 1)
data <- data.frame(N, x, y, x_binary)
```

**Regression with binary predictor**

```{r }
lm_1a <- lm(y ~ x_binary, data = data)
display(lm_1a)
```

**Plots**

```{r eval=TRUE, include=FALSE}
if (savefigs) png(root("03-statistical-inference-simulation/figs","overview_1a.png"), height=3.5, width=4.5)
```


```{r }
data %>%
  ggplot(aes(x=x_binary,y=y)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x="", y="Outcome measurement",title="Regression with binary treatment") +
  geom_text( aes(x=0.3,y=13,label=paste("Estimated treatment effect is\nslope of fitted line: ", fround(coef(lm_1a)[2], 1)),
            parse = TRUE))

```


**Classical regression with continuous predictor**

```{r }
lm_1b <- lm(y ~ x, data = data)
display(lm_1b)

```
`
```{r }
data %>%
  ggplot(aes(x=x,y=y)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x="Treatment level", y="Outcome measurement",title="Regression with continuous treatment") +
  geom_text( aes(x=3.2,y=15,label=paste("Estimated treatment\neffect per unit of x is\nslope of fitted line: ", fround(coef(lm_1b)[2], 1)),
            parse = TRUE))

```

**Simulated data from nonlinear model**

```{r }
y <- rnorm(N, 5 + 30*exp(-x), 2)
data$y <- y
```

**Classical regression with continuous predictor**

```{r }
lm_2a <- lm(y ~ x, data = data)
display(lm_2a)

```

```{r }
data %>%
  ggplot(aes(x=x,y=y)) +
  geom_point() +
  #geom_smooth(method = "loess", se = FALSE) +
  labs(x="Treatment level", y="Outcome measurement",title="Nonlinear treatment effect") +
  geom_function(fun=function(x) 5+ 30*exp(-x))

```



```{r }
data %>%
  ggplot(aes(x=x,y=y)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
    labs(x="Treatment level", y="Outcome measurement",title="Nonlinear effect, estimated with straight line fit")
```


**Simulated data from two groups**

```{r }
N <- 100
xx <- rnorm(N, 0, 1)^2
z <- rep(0:1, N/2)
xx <- ifelse(z==0, rnorm(N, 0, 1.2)^2, rnorm(N, 0, .8)^2)
yy <- rnorm(N, 20 + 5*xx + 10*z, 3)
data <- data.frame(xx, z, yy)
lm_2 <- lm(yy ~ xx + z, data=data)
display(lm_2)

```


```{r }

data %>%
  ggplot(aes(x=xx,y=yy,colour=as.factor(z))) +
  geom_point() +
    labs(x="Pre- treatment predictor", y="Outcome measurement",title="Continuous pre-treatment predictor and binary treatment") +
  geom_abline(intercept =coef(lm_2)[1],slope = coef(lm_2)[2] ) +
  geom_abline(coef(lm_2)[2]+coef(lm_2)[3],slope =coef(lm_2)[2]) +
geom_abline(coef(lm_2)[1] + coef(lm_2)[3])+
  geom_text(x0+.1, coef(lm_2)[1] + coef(lm_2)[2]*x0 + .5*coef(lm_2)[3], label=paste("Estimated\ntreatment\neffect is", fround(coef(lm_2)[3], 1)))
```

```{r eval=TRUE, include=FALSE}
if (savefigs) dev.off()

for (j in 0:1) print(mean(yy[z==j]))
for (j in 0:1) print(mean(xx[z==j]))
```

